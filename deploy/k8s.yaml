name: CI with Minikube and Pytest

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run tests
        run: pytest test_app.py

      - name: Set up Minikube
        uses: medyagh/setup-minikube@latest

      - name: Enable Minikube Docker Env
        run: |
          eval $(minikube docker-env)
          docker info  # Just to confirm Docker is working inside Minikube

      - name: Build Docker image inside Minikube
        run: |
          eval $(minikube docker-env)
          docker build -t local/example:latest .

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f deploy/k8s.yaml

      - name: Wait for pods to be ready
        run: |
          kubectl wait --for=condition=ready pod -l app=example --timeout=90s

      - name: Get all resources for debug
        run: kubectl get all
